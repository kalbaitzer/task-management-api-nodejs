# Configuração do container para execução em outros computadores

# Define os serviços (contêineres) que compõem a sua aplicação.
services:
  # Serviço da API Node.js, baixado do Docker Hub
  app:
    # O Docker irá baixar esta imagem automaticamente se ela não existir localmente.
    container_name: task-management-api-nodejs
    image: kalbaitzer/task-management-api-nodejs:1.0
    ports:
      - "3000:3000"          # Mapeia a porta 3000 do contêiner para a porta 3000 da sua máquina
    env_file:
      - ./config/.env.docker # Carrega as variáveis de ambiente do arquivo .env
    depends_on:
      - mongo                # Garante que o contêiner do MongoDB inicie antes da API
      - redis                # Garante que o contêiner do Redis inicie antes da API

  # Serviço do Banco de Dados MongoDB
  mongo:
    image: mongo:latest # Usa a imagem oficial mais recente do MongoDB
    container_name: mongodb
    ports:
      - "27017:27017" # Mapeia a porta padrão do MongoDB
    volumes:
      - mongo-data:/data/db # Cria um volume para persistir os dados do banco

  # Serviço do Banco de Dados Redis (cache)
  redis:
    image: redis:7-alpine # Imagem oficial e leve do Redis
    container_name: redis
    ports:
      - "6379:6379" # Expõe a porta padrão do Redis
    volumes:
      - redis-data:/data

  # Serviço do Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090" # Porta padrão do Prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml # Mapeia nosso arquivo de config
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    depends_on:
      - app # Garante que o Prometheus só inicie depois da nossa API

  # Serviço do Grafana
  grafana:
    image: grafana/grafana-oss:latest
    container_name: grafana
    ports:
      - "3001:3000" # Mapeia a porta 3000 do Grafana para 3001 na nossa máquina (para não conflitar com a API)
    volumes:
      - grafana-data:/var/lib/grafana # Volume para persistir dashboards e configurações
    depends_on:
      - prometheus

# Define o volume para persistência de dados do MongoDB
volumes:
  mongo-data:
  redis-data:
  grafana-data: